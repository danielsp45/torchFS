#!/usr/bin/env bash
set -Eeuo pipefail

# Function to display help message
function display_help() {
  cat <<EOF
Usage: $(basename "$0") [options]

This script starts the TorchFS metadata server.
Options:
  --port=<port>     Port number for the metadata server (default: 8000)
  --conf=<conf>     Initial configuration of the replication group 
                    (e.g. "127.0.0.1:8000,127.0.0.1:9000")
  --path=<path>     Path to the metadata server storage (default: /tmp/metadata)
  --host=<host>     Host address for the metadata server (default:
  -h, --help        Show this help message.
EOF
}

# Default values
port=8000
conf="127.0.1.1:8000:0"
path="/tmp/metadata"
host="127.0.2.1"

# Parse command-line options
while [[ $# -gt 0 ]]; do
  case "$1" in
    --port=*)
      port="${1#*=}"
      shift
      ;;
    --conf=*)
      conf="${1#*=}"
      shift
      ;;
    --path=*)
      path="${1#*=}"
      shift
      ;;
    --host=*)
      host="${1#*=}"
      shift
      ;;
    -h|--help)
      display_help
      exit 0
      ;;
    *)
      echo "Unknown option: $1"
      display_help
      exit 1
      ;;
  esac
done

echo "Starting metadata server (listening on port ${port})..."
echo "Using conf: ${conf}"

# Change to project root (assumes this script is in the bin/ directory)
BASE_DIR="$(dirname "${BASH_SOURCE[0]}")"
cd "${BASE_DIR}/.." || exit 127

# Launch the metadata server binary with the provided flags.
./build/metadata -port "${port}" -conf "${conf}" -path "${path}" -host "${host}"